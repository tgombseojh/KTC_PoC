<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>KTC - ëŒ€ê¸°ì—´ PoC</title>
    <!-- SockJSì™€ Stomp.js ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë“œ -->
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
    <style>
        body {
            font-size: 4em;
            margin: 0.5em;
            font-family: Arial, sans-serif;
            background-color: #f7f7f7;
        }
        #output {
            white-space: pre-wrap;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }
        button {
            background-color: #3498db;
            color: #fff;
            border: none;
            border-radius: 10px;
            font-size: 1em;
            padding: 0.5em 1em;
            cursor: pointer;
            box-shadow: 0 4px 6px rgba(0,0,0,0.15);
            transition: transform 0.1s ease-in-out, box-shadow 0.1s ease-in-out;
        }
        button:hover {
            box-shadow: 0 6px 8px rgba(0,0,0,0.2);
        }
        button:active {
            transform: translateY(2px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body>
<h1>KTC - ëŒ€ê¸°ì—´ PoC</h1>
<pre id="output"></pre>
<div>
    <button onclick="connect()">ëŒ€ê¸°ì—´ ì ‘ì†</button>
    <button onclick="disconnect()">ëŒ€ê¸°ì—´ ë‚˜ê°€ê¸°</button>
</div>
<script>
    var stompClient = null;
    var currentOrder = 0;
    var leftOrder = 0;
    var isTheEnd = false;

    function log(message) {
        var output = document.getElementById("output");
        output.innerHTML += message + "<br>";
        output.scrollTop = output.scrollHeight;
    }

    function connect() {
        // ì´ë¯¸ ì—°ê²°ë˜ì–´ ìˆìœ¼ë©´ ì¶”ê°€ ì—°ê²°í•˜ì§€ ì•ŠìŒ
        if (stompClient && stompClient.connected) {
            log("ì´ë¯¸ ì—°ê²°ë˜ì–´ ìˆìŠµë‹ˆë‹¤.");
            return;
        }

        var socket = new SockJS('/ws');
        stompClient = Stomp.over(socket);
        stompClient.heartbeat.outgoing = 5000; // ì„œë²„ì— í•˜íŠ¸ë¹„íŠ¸ ë³´ë‚´ê¸°
        stompClient.connect({}, function(frame) {
            //log("ì—°ê²°ë¨: " + frame);
            log("ëŒ€ê¸°ì—´ì— ì—°ê²°ë˜ì—ˆìŠµë‹ˆë‹¤.");

            // /topic/order í† í”½ êµ¬ë… (ì´ˆê¸° ìˆœë²ˆ ì—…ë°ì´íŠ¸)
            stompClient.subscribe('/user/queue/order', function(message) {
                currentOrder = parseInt(message.body, 10);
                log("ê³ ê°ë‹˜ì˜ ìˆœë²ˆì€: " + currentOrder +"ë²ˆì§¸ ì…ë‹ˆë‹¤.");
            });

            // /topic/waiting í† í”½ êµ¬ë… (-1 ì´ë²¤íŠ¸ ìˆ˜ì‹ )
            stompClient.subscribe('/topic/waiting', function(message) {
                leftOrder = parseInt(message.body, 10);
                if (currentOrder > 1) {
                    if (currentOrder > leftOrder) {
                        currentOrder--;
                        log("ì•ì„  ê³ ê°ë‹˜ë“¤ì˜ ì ‘ì† ì¢…ë£Œë¡œ ì¸í•´ ìˆœë²ˆ ê°ì†Œ, \nê³ ê°ë‹˜ì˜ ìƒˆë¡œìš´ ìˆœë²ˆì€ " + currentOrder +"ë²ˆì§¸ ì…ë‹ˆë‹¤.");
                        stompClient.send("/app/update-order", {}, JSON.stringify({ newOrder: currentOrder }));
                    }
                }
                if (!isTheEnd) {
                    if (currentOrder === 1) {
                        log("ğŸ‰ ë‹¹ì‹ ì˜ ìˆœë²ˆì…ë‹ˆë‹¤! 3ë¶„ í›„ì— ì…ì¥í•©ë‹ˆë‹¤...");
                        setTimeout(function () {
                            stompClient.disconnect(function () {
                                log("â›” ì…ì¥ ì™„ë£Œ - ëŒ€ê¸°ì—´ì—ì„œ ë‚˜ê°”ìŠµë‹ˆë‹¤.");
                            });
                        }, 180000); // 1ë¶„ = 60000ms
                        isTheEnd = true;
                    }
                }
            });

            // ì ‘ì† ì‹œ /app/join ë©”ì‹œì§€ë¥¼ ë³´ë‚´ ì´ˆê¸° ìˆœë²ˆ í• ë‹¹ ìš”ì²­
            stompClient.send("/app/join", {}, "");
        });
    }

    function disconnect() {
        if (stompClient !== null && stompClient.connected) {
            stompClient.disconnect(function() {
                log("ëŒ€ê¸°ì—´ ì—°ê²° ì¢…ë£Œë¨");
            });
        } else {
            log("ì—°ê²°ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤.");
        }
    }
</script>
</body>
</html>
