<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>KTC - ëŒ€ê¸°ì—´ PoC</title>
    <!-- Stomp.js (ìˆœìˆ˜ WebSocket ì§€ì› ê°€ëŠ¥) -->
    <script src="https://cdn.jsdelivr.net/npm/@stomp/stompjs@7.0.0/bundles/stomp.umd.min.js"></script>
    <style>
        body {
            font-size: 4em;
            margin: 0.5em;
            font-family: Arial, sans-serif;
            background-color: #f7f7f7;
        }
        #output {
            white-space: pre-wrap;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }
        button {
            background-color: #3498db;
            color: #fff;
            border: none;
            border-radius: 10px;
            font-size: 1em;
            padding: 0.5em 1em;
            cursor: pointer;
            box-shadow: 0 4px 6px rgba(0,0,0,0.15);
            transition: transform 0.1s ease-in-out, box-shadow 0.1s ease-in-out;
        }
        button:hover {
            box-shadow: 0 6px 8px rgba(0,0,0,0.2);
        }
        button:active {
            transform: translateY(2px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body>
<h1>KTC - ëŒ€ê¸°ì—´ PoC</h1>
<div>
    <button onclick="connect()">ëŒ€ê¸°ì—´ ì ‘ì†</button>
    <button onclick="disconnect()">ëŒ€ê¸°ì—´ ë‚˜ê°€ê¸°</button>
</div>
<pre id="output"></pre>
<script>
    const SERVER_URL = "ws://10.205.0.108:8080/ws";  // âœ… ìˆœìˆ˜ WebSocket ì£¼ì†Œ
    let stompClient = null;
    let currentOrder = 0;
    let leftOrder = 0;
    let sessions = 0;
    let outReserve = false;

    function log(message) {
        const output = document.getElementById("output");
        output.innerHTML = message + "<br>" + output.innerHTML;
    }

    function cleanLog(message) {
        const output = document.getElementById("output");
        output.innerHTML = message;
    }

    function connect() {
        if (stompClient && stompClient.connected) {
            log("ì´ë¯¸ ì—°ê²°ë˜ì–´ ìˆìŠµë‹ˆë‹¤.");
            log(" ");
            return;
        }

        stompClient = new StompJs.Client({
            brokerURL: SERVER_URL, // âœ… ì§ì ‘ WebSocket URL ì§€ì •
            connectHeaders: {},
            debug: function (str) {
                //console.log(str); // í•„ìš” ì‹œ í™œì„±í™”
            },
            heartbeatIncoming: 5000,
            heartbeatOutgoing: 5000,
            reconnectDelay: 0,
            onConnect: function (frame) {
                cleanLog("ëŒ€ê¸°ì—´ì— ì—°ê²°ë˜ì—ˆìŠµë‹ˆë‹¤.");
                log(" ");

                // ê°œì¸ë©”ì„¸ì§€ ë°›ëŠ” í† í”½
                stompClient.subscribe('/user/queue/order', function(message) {
                    currentOrder = parseInt(message.body, 10);
                    log("ê³ ê°ë‹˜ì˜ ìˆœë²ˆì€: " + currentOrder + "ë²ˆì§¸ ì…ë‹ˆë‹¤.");
                    log(" ");
                    if (currentOrder === 1) {
                        log("ğŸ‰ ê³ ê°ë‹˜ì´ ì…ì¥í•˜ì‹¤ ì°¨ë¡€ì…ë‹ˆë‹¤! 30ì´ˆ í›„ì— ë©”ì¸í™”ë©´ìœ¼ë¡œ ì§„ì…í•©ë‹ˆë‹¤...");
                        log(" ");
                        setTimeout(function () {
                            stompClient.webSocket.close();
                            log("â›” ë©”ì¸í™”ë©´ ì…ì¥ ì™„ë£Œ - ëŒ€ê¸°ì—´ì—ì„œ ë‚˜ê°”ìŠµë‹ˆë‹¤.");
                            //log(" ë¶€í•˜í…ŒìŠ¤íŠ¸ë¥¼ ìœ„í•´ 5ì´ˆ í›„ ëŒ€ê¸°ì—´ì— ì¬ì…ì¥ í•©ë‹ˆë‹¤.");
                            log(" ");
                            outReserve = true;
                        }, 30000);
                    }
                });

                // ëª‡ë²ˆì§¸ ëŒ€ê¸°ìê°€ ì¼íƒˆí–ˆë‹¤ëŠ” ë¸Œë¡œë“œìºìŠ¤íŒ… í† í”½
                stompClient.subscribe('/topic/waiting', function(message) {
                    leftOrder = parseInt(message.body, 10);
                    if (currentOrder > 1 && currentOrder > leftOrder) {
                        currentOrder--;
                        log("ê³ ê°ë‹˜ì˜ ìˆœë²ˆì€: " + currentOrder + "ë²ˆì§¸ ì…ë‹ˆë‹¤.");
                        log(" ");
                        // í´ë¼ì´ì–¸íŠ¸ì˜ ìˆœë²ˆì„ ì„œë²„ë¡œ ì „ì†¡
                        stompClient.publish({
                            destination: "/app/update-order",
                            body: JSON.stringify({ newOrder: currentOrder })
                        });
                    }

                    if (!outReserve && currentOrder === 1) {
                        log("ğŸ‰ ê³ ê°ë‹˜ì´ ì…ì¥í•˜ì‹¤ ì°¨ë¡€ì…ë‹ˆë‹¤! 30ì´ˆ í›„ì— ë©”ì¸í™”ë©´ìœ¼ë¡œ ì§„ì…í•©ë‹ˆë‹¤...");
                        setTimeout(function () {
                            //disconnect();
                            stompClient.webSocket.close();  // ìë™ì¬ì ‘ì†ìœ¼ë¡œ ì„œë²„ì— ë¶€í•˜ë¥¼ ì£¼ê¸° ìœ„í•´ì„œ
                            log("â›” ë©”ì¸í™”ë©´ìœ¼ë¡œ ì§„ì… - ëŒ€ê¸°ì—´ì—ì„œ ë‚˜ê°”ìŠµë‹ˆë‹¤.");
                            //log(" ë¶€í•˜í…ŒìŠ¤íŠ¸ë¥¼ ìœ„í•´ 5ì´ˆ í›„ ëŒ€ê¸°ì—´ì— ì¬ì…ì¥ í•©ë‹ˆë‹¤.");
                            log(" ");
                        }, 30000);
                    }
                });

                // ì„œë²„ì˜ í™œì„¤ ì„¸ì…˜ ìˆ˜ë¥¼ ë°›ëŠ” ë¸Œë¡œë“œìºìŠ¤íŒ… í† í”½
                stompClient.subscribe('/topic/sessions', function(message) {
                    sessions = parseInt(message.body, 10);
                    if (currentOrder > sessions) {
                        currentOrder = sessions;
                        log("ê³ ê°ë‹˜ì˜ ìˆœë²ˆì€: " + currentOrder + "ë²ˆì§¸ ì…ë‹ˆë‹¤.");
                        log(" ");
                        stompClient.publish({
                            destination: "/app/update-order",
                            body: JSON.stringify({ newOrder: currentOrder })
                        });
                    }
                });

                // ìˆœë²ˆ í• ë‹¹ ìš”ì²­. ì„œë²„ì˜ ì‘ë‹µì€ ê°œì¸ í† í”½ìœ¼ë¡œ ì „ë‹¬.
                stompClient.publish({
                    destination: "/app/join",
                    body: ""
                });
            },
            onStompError: function (frame) {
                log("â— STOMP ì—ëŸ¬ ë°œìƒ: " + frame.headers['message']);
            },
            onWebSocketClose: function () {
                // âœ… ì—°ê²° ëŠê²¼ì„ ë•Œ ìˆœë²ˆ ì´ˆê¸°í™”
                currentOrder = 0;
                log("âŒ ëŒ€ê¸°ì—´ ì—°ê²°ì´ ëŠê²¼ìŠµë‹ˆë‹¤.");
            }
        });

        stompClient.activate();
    }

    function disconnect() {
        if (stompClient && stompClient.connected) {
            stompClient.deactivate();
            log("ëŒ€ê¸°ì—´ ì—°ê²° ì¢…ë£Œë¨");
            currentOrder = 0;
        } else {
            log("ì—°ê²°ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤.");
        }
    }
</script>
</body>
</html>
