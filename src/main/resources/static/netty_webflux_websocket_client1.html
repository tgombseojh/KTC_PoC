<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>WebSocket ëŒ€ê¸°ì—´ í´ë¼ì´ì–¸íŠ¸</title>
    <style>
        body { font-family: sans-serif; font-size: 1.2em; padding: 1em; background: #f9f9f9; }
        #log { white-space: pre-wrap; background: #fff; border: 1px solid #ccc; padding: 1em; height: 300px; overflow-y: auto; }
        button { margin-right: 0.5em; }
    </style>
</head>
<body>

<h2>ğŸ“¡ WebSocket ëŒ€ê¸°ì—´ í´ë¼ì´ì–¸íŠ¸</h2>
<div id="log"></div>
<br>
<button onclick="connect()">ì—°ê²°</button>
<button onclick="leave()">ìˆ˜ë™ ì´íƒˆ</button>

<script>
    let socket;
    let currentOrder = 0;
    let sessions = 0; // âœ… ì „ì—­ ë³€ìˆ˜ë¡œ ì„¸ì…˜ ìˆ˜ ì €ì¥

    function log(message) {
        const logEl = document.getElementById("log");
        logEl.textContent += message + "\n";
        logEl.scrollTop = logEl.scrollHeight;
    }

    function connect() {
        if (socket && socket.readyState === WebSocket.OPEN) {
            log("âš ï¸ ì´ë¯¸ ì—°ê²°ë˜ì–´ ìˆìŠµë‹ˆë‹¤.");
            return;
        }

        socket = new WebSocket("ws://localhost:8080/ws");

        socket.onopen = () => {
            log("âœ… ì—°ê²°ë¨");
        };

        socket.onmessage = (event) => {
            const msg = event.data;
            //log("ğŸ“¥ ìˆ˜ì‹ : " + msg);

            if (msg === "BUSY") {
                console.log("âš ï¸ ì„œë²„ê°€ ë°”ì©ë‹ˆë‹¤. 5ì´ˆ í›„ ì¬ì‹œë„...");
                socket.close();
                setTimeout(connect, 5000);
            } else if (msg.startsWith("ORDER:")) {
                currentOrder = parseInt(msg.split(":")[1]);
                log("ğŸŸ¢ ë‚´ ìˆœë²ˆì€ " + currentOrder + "ë²ˆì…ë‹ˆë‹¤.");
            } else if (msg.startsWith("WAITING:")) {
                const leftOrder = parseInt(msg.split(":")[1]);

                if (currentOrder > leftOrder) {
                    // ìˆœë²ˆì„ 1 ê°ì†Œí•œ í›„ ìµœì†Œ 1ë¡œ ë³´ì¥
                    currentOrder = Math.max(currentOrder - 1, 1);
                    log(`âš ï¸ ìˆœë²ˆ ${leftOrder}ë²ˆ ì´íƒˆ â†’ ë‚´ ìˆœë²ˆ ë³´ì •: ${currentOrder} (ì´ ëŒ€ê¸°ì ìˆ˜: ${sessions})`);
                    socket.send("UPDATE:" + currentOrder);
                }
            } else if (msg.startsWith("SESSIONS:")) {
                const parsed = parseInt(msg.split(":")[1]);
                if (!isNaN(parsed) && parsed > 0) {
                    sessions = parsed;
                    if (currentOrder > sessions) currentOrder = sessions;
                    log(`âš ï¸ ë‚´ ìˆœë²ˆ: ${currentOrder} (ì´ ëŒ€ê¸°ì ìˆ˜: ${sessions})`);
                } else {
                    log("âš ï¸ ì˜ëª»ëœ ì„¸ì…˜ ìˆ˜ ìˆ˜ì‹ ë¨:", parsed);
                }
            }
        };

        socket.onclose = () => {
            log("â›” ì—°ê²° ì¢…ë£Œ");
            socket = null; // ì—°ê²°ì´ ëŠê¸°ë©´ ìƒíƒœ ì´ˆê¸°í™”
        };
    }


    function leave() {
        if (socket && socket.readyState === WebSocket.OPEN) {
            socket.send("LEAVE");
            //log("ğŸ“¤ ìˆ˜ë™ ì´íƒˆ ì „ì†¡ë¨");
        } else {
            log("ì´ë¯¸ ì—°ê²°ì´ ì¢…ë£Œë˜ì–´ìˆìŠµë‹ˆë‹¤.");
        }
    }
</script>
</body>
</html>
